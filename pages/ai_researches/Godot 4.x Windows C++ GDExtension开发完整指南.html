<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Godot 4.x Windows C++ GDExtension开发完整指南</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card h2::before {
            content: "▶";
            color: #3498db;
            font-size: 0.8em;
        }
        
        .card h3 {
            color: #34495e;
            margin: 20px 0 10px 0;
            padding-left: 15px;
            border-left: 3px solid #9b59b6;
        }
        
        .content-section {
            margin-bottom: 30px;
        }
        
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            line-height: 1.4;
        }
        
        .code-block code {
            display: block;
            white-space: pre-wrap;
        }
        
        .tip-box {
            background: #e8f6f3;
            border-left: 4px solid #1abc9c;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .warning-box {
            background: #fdedec;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .info-box {
            background: #eaf2f8;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        details {
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        
        summary {
            padding: 15px;
            background: #f8f9fa;
            cursor: pointer;
            font-weight: bold;
            color: #2c3e50;
            transition: background 0.3s;
        }
        
        summary:hover {
            background: #e9ecef;
        }
        
        details[open] summary {
            background: #3498db;
            color: white;
        }
        
        .details-content {
            padding: 15px;
            background: white;
        }
        
        .step-list {
            counter-reset: step-counter;
            list-style: none;
            padding-left: 0;
        }
        
        .step-list li {
            counter-increment: step-counter;
            margin-bottom: 15px;
            padding-left: 50px;
            position: relative;
        }
        
        .step-list li::before {
            content: counter(step-counter);
            background: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            left: 0;
            top: 0;
            font-weight: bold;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: white;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Godot 4.x Windows C++ GDExtension开发完整指南</h1>
            <div class="subtitle">从环境配置到项目部署的完整解决方案</div>
        </div>

        <div class="card">
            <h2>一、开发环境准备与项目搭建</h2>
            <div class="content-section">
                <h3>1.1 系统要求与软件版本确认</h3>
                <p>Windows 10或11 64位操作系统，处理器支持x86_64架构，至少4GB内存，建议8GB以上。</p>
                
                <div class="tip-box">
                    <strong>版本说明：</strong> 当前最新的稳定版本是Godot 4.5.1，数字商店版本不包含.NET/C#支持。
                </div>
            </div>

            <div class="content-section">
                <h3>1.2 开发工具链安装</h3>
                
                <details>
                    <summary>Visual Studio 2022安装</summary>
                    <div class="details-content">
                        <p>官方推荐的编译器，需要安装以下组件：</p>
                        <ul>
                            <li>C++桌面开发工作负载</li>
                            <li>Windows 10 SDK（建议版本10.0.19041.0或更高）</li>
                            <li>C++ CMake工具（可选但推荐）</li>
                        </ul>
                    </div>
                </details>

                <details>
                    <summary>Python与SCons安装</summary>
                    <div class="details-content">
                        <p>需要安装Python 3.8.x或更高版本和SCons 4.9.1或更高版本：</p>
                        <div class="code-block">
                            <code>pip install scons</code>
                        </div>
                    </div>
                </details>
            </div>

            <div class="content-section">
                <h3>1.3 项目结构设计与初始化</h3>
                <p>推荐的项目目录结构：</p>
                <div class="code-block">
                    <code>project_root/
├── source/         # Godot游戏项目源码目录
├── godot-cpp/      # godot-cpp库目录
├── gamelib-vs/     # Visual Studio项目目录
└── SConstruct       # 主编译文件</code>
                </div>
                
                <details>
                    <summary>godot-cpp获取与初始化</summary>
                    <div class="details-content">
                        <ol class="step-list">
                            <li>克隆godot-cpp仓库</li>
                            <li>初始化子模块</li>
                            <li>生成extension_api.json文件</li>
                        </ol>
                    </div>
                </details>
            </div>
        </div>

        <div class="card">
            <h2>二、GDExtension基础配置与代码结构</h2>
            
            <div class="content-section">
                <h3>2.1 GDExtension架构原理</h3>
                <p>GDExtension是Godot 4.0引入的革命性扩展机制，相比传统的GDNative，它提供了更简洁的API、更好的性能和对现代C++特性的支持。</p>
            </div>

            <div class="content-section">
                <h3>2.2 基础类定义与注册机制</h3>
                
                <details>
                    <summary>类定义基础语法</summary>
                    <div class="details-content">
                        <div class="code-block">
                            <code>class MyClass : public Node {
    GDCLASS(MyClass, Node);

protected:
    static void _bind_methods();

public:
    MyClass();
    ~MyClass();
    void say_hello(const String &name);
    int add_numbers(int a, int b);
};</code>
                        </div>
                    </div>
                </details>

                <details>
                    <summary>方法绑定实现</summary>
                    <div class="details-content">
                        <div class="code-block">
                            <code>void MyClass::_bind_methods() {
    ClassDB::bind_method(D_METHOD("say_hello", "name"), 
                        &MyClass::say_hello);
    ClassDB::bind_method(D_METHOD("add_numbers", "a", "b"), 
                        &MyClass::add_numbers);
}</code>
                        </div>
                    </div>
                </details>
            </div>

            <div class="content-section">
                <h3>2.3 类型映射与内存管理</h3>
                <p>Godot使用Variant类型作为通用数据类型，gdextension提供了强大的引用计数内存管理系统。</p>
                
                <div class="info-box">
                    <strong>内存管理最佳实践：</strong> 使用memnew创建对象，使用Ref&lt;T&gt;管理所有RefCounted派生类的对象，避免循环引用。
                </div>
            </div>
        </div>

        <div class="card">
            <h2>三、编译配置与SConstruct文件详解</h2>
            
            <div class="content-section">
                <h3>3.1 SConstruct文件结构与语法基础</h3>
                <p>SConstruct是SCons构建系统的核心配置文件，用于定义项目的编译规则、依赖关系和输出配置。</p>
                
                <details>
                    <summary>基础SConstruct文件结构</summary>
                    <div class="details-content">
                        <div class="code-block">
                            <code>import os
import sys

# 导入godot-cpp的构建环境
env = SConscript("godot-cpp/SConstruct")

# 配置编译选项
env.Append(CPPPATH=["src/"])
sources = Glob("src/*.cpp")

# Windows平台配置
if env["platform"] == "windows":
    library = env.SharedLibrary(
        "bin/libgame.windows.template_debug.x86_64.dll",
        source=sources
    )

Default(library)</code>
                        </div>
                    </div>
                </details>
            </div>

            <div class="content-section">
                <h3>3.2 Windows平台编译配置详解</h3>
                
                <div class="warning-box">
                    <strong>常见错误：</strong> 运行时库不匹配，例如 error LNK2038: mismatch detected for 'RuntimeLibrary'
                </div>
                
                <p>解决方案是确保所有项目都使用相同的运行时库配置：</p>
                <div class="code-block">
                    <code>if env["platform"] == "windows":
    # 设置运行时库为多线程调试DLL
    env.Append(CXXFLAGS=["/MDd"])</code>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>四、DLL文件生成问题深度排查</h2>
            
            <div class="content-section">
                <h3>4.1 常见编译错误类型与解决方案</h3>
                
                <details>
                    <summary>编译器错误</summary>
                    <div class="details-content">
                        <p><strong>错误：未定义的标识符</strong></p>
                        <div class="code-block">
                            <code>error C2065: 'GDCLASS' : undeclared identifier</code>
                        </div>
                        <p><strong>解决方案：</strong> 确保包含了正确的头文件</p>
                        <div class="code-block">
                            <code>#include &lt;godot_cpp/core/binder_common.hpp&gt;
#include &lt;godot_cpp/classes/node.hpp&gt;</code>
                        </div>
                    </div>
                </details>

                <details>
                    <summary>链接器错误</summary>
                    <div class="details-content">
                        <p><strong>错误：无法解析的外部符号</strong></p>
                        <div class="code-block">
                            <code>error LNK2019: unresolved external symbol 
"void __cdecl godot::ClassDB::register_class&lt;class MyClass&gt;(void)"</code>
                        </div>
                        <p><strong>解决方案：</strong> 确保类注册函数正确实现，检查头文件包含是否正确</p>
                    </div>
                </details>
            </div>

            <div class="content-section">
                <h3>4.2 实际案例分析与解决步骤</h3>
                
                <details>
                    <summary>案例一：dll文件完全不生成</summary>
                    <div class="details-content">
                        <p><strong>问题描述：</strong> 执行scons命令后，没有生成任何dll文件，也没有错误信息。</p>
                        <p><strong>排查步骤：</strong></p>
                        <ol class="step-list">
                            <li>检查SConstruct文件是否存在且路径正确</li>
                            <li>确认源文件存在且扩展名正确</li>
                            <li>执行scons -v查看详细输出</li>
                            <li>在SConstruct中添加调试信息</li>
                        </ol>
                    </div>
                </details>

                <details>
                    <summary>案例二：生成的dll文件无法加载</summary>
                    <div class="details-content">
                        <p><strong>问题描述：</strong> dll文件生成成功，但在Godot中加载时提示"不是有效的Win32应用程序"。</p>
                        <p><strong>排查步骤：</strong></p>
                        <ol class="step-list">
                            <li>检查平台架构是否一致（64位）</li>
                            <li>使用Dependency Walker检查dll依赖</li>
                            <li>检查gdextension文件配置</li>
                        </ol>
                    </div>
                </details>
            </div>
        </div>

        <div class="card">
            <h2>五、实践案例：创建一个简单的GDExtension</h2>
            
            <div class="content-section">
                <h3>5.1 案例项目概述</h3>
                <p>创建一个MathUtils gdextension，提供数学计算功能：</p>
                <ul>
                    <li>向量运算（加法、减法、点积）</li>
                    <li>数学常数（π、e）</li>
                    <li>数学函数（正弦、余弦、平方根）</li>
                    <li>随机数生成器</li>
                </ul>
            </div>

            <div class="content-section">
                <h3>5.2 核心代码实现</h3>
                
                <details>
                    <summary>向量运算类</summary>
                    <div class="details-content">
                        <div class="code-block">
                            <code>class MathVectors : public Reference {
    GDCLASS(MathVectors, Reference);
    
public:
    static Vector3 vector_add(const Vector3 &a, const Vector3 &b) {
        return a + b;
    }
    
protected:
    static void _bind_methods() {
        ClassDB::bind_static_method(
            D_METHOD("vector_add", "a", "b"), 
            &MathVectors::vector_add);
    }
};</code>
                        </div>
                    </div>
                </details>

                <details>
                    <summary>注册函数</summary>
                    <div class="details-content">
                        <div class="code-block">
                            <code>extern "C" {
GDExtensionBool GDE_EXPORT mathutils_library_init(
    GDExtensionInterfaceGetProcAddress p_get_proc_address,
    GDExtensionClassLibraryPtr p_library,
    GDExtensionInitialization *r_initialization) {
    
    godot::GDExtensionBinding::InitObject init_obj(
        p_get_proc_address, p_library, r_initialization);
    
    init_obj.register_initializer(initialize_mathutils_module);
    init_obj.set_minimum_library_initialization_level(
        MODULE_INITIALIZATION_LEVEL_SCENE);
    
    return init_obj.init();
}
}</code>
                        </div>
                    </div>
                </details>
            </div>

            <div class="content-section">
                <h3>5.3 Godot中使用示例</h3>
                <div class="code-block">
                    <code>extends Node2D

func _ready():
    var a = Vector3(1, 2, 3)
    var b = Vector3(4, 5, 6)
    
    var result_add = MathVectors.vector_add(a, b)
    var pi = MathConstants.get_pi()
    var sin_value = MathFunctions.sin(pi/4)
    
    print("向量加法结果: ", result_add)
    print("π = ", pi)
    print("sin(π/4) = ", sin_value)</code>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>六、最佳实践与性能优化</h2>
            
            <div class="content-section">
                <h3>6.1 代码组织与架构设计</h3>
                <p><strong>模块化设计原则：</strong></p>
                <ul>
                    <li>单一职责原则：每个类只负责一个功能</li>
                    <li>开闭原则：对扩展开放，对修改关闭</li>
                    <li>依赖倒置原则：依赖抽象而非具体实现</li>
                </ul>
            </div>

            <div class="content-section">
                <h3>6.2 性能优化策略</h3>
                
                <details>
                    <summary>内存访问优化</summary>
                    <div class="details-content">
                        <p><strong>提高缓存命中率：</strong></p>
                        <div class="code-block">
                            <code>// 按顺序访问数组
for (int i = 0; i < points.size(); ++i) {
    process(points[i]);
}

// 使用alignas确保数据对齐
alignas(64) struct PointCloud {
    std::vector&lt;Vector3&gt; points;
};</code>
                        </div>
                    </div>
                </details>

                <details>
                    <summary>编译器优化</summary>
                    <div class="details-content">
                        <div class="code-block">
                            <code># 在SConstruct中启用优化
if env["target"] == "template_release":
    # 启用全优化
    env.Append(CXXFLAGS=["/O2"])
    # 启用链接时代码生成
    env.Append(LINKFLAGS=["/LTCG"])</code>
                        </div>
                    </div>
                </details>
            </div>

            <div class="content-section">
                <h3>6.3 调试与测试最佳实践</h3>
                <p>使用Godot的调试工具：</p>
                <div class="code-block">
                    <code>// 使用GD_PRINT宏输出调试信息
GD_PRINT("Vector magnitude: ", magnitude);

// 输出变量信息
Vector3 v(1, 2, 3);
GD_PRINT("Vector: ", v);</code>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Godot 4.x GDExtension开发指南 - 内容由AI生成</p>
        </div>
    </div>
</body>
</html>